---
title: "psrs/prs analysis"
author: "Hinna"
date: "2025"
output: html_document
---

```{R}
## å¯¼å…¥æ•°æ®
library(haven)
library(openxlsx)
library(survminer)
library(survival)
library(jstable)

df <- read_sav("./res_update.sav")
df <- df[, -89]
df[, paste0("x", 1:15)] <- lapply(df[, paste0("x", 1:15)], as.factor)

## ä¿®æ”¹å‰10ä¸ªpcæˆåˆ†åç§°å’Œgenotype batch
colnames(df)[101:111] <- c("genotype_array", paste0("pc", 1:10))
write.csv(df, "res_new.csv")

df_sub <- df[, c("drinking", "smoking", "sex", "PSRS_3", "psrs", "PRS","age", "BMI", "Apoe", "cancer", 
                 "hypertension", "choloresteral", "family_history", "TimeYACD", "TimeYAD", "TimeYVD", "ACD", "AD", "VD", "SCORE1_AVG", "insulin", "stroke", "CVD", "genotype_array", "pc1", "pc2", "pc3", "pc4", "pc5", "pc6", "pc7", "pc8",
                 "pc9", "pc10", paste0("x", 1:15))]

colnames(df_sub) <- c("drinking", "smoking", "sex", "PsRS", "psrs", "PRS","Age", "BMI", "APOE_status", "cancer history", 
                 "hypertension history", "cholesterol usage", "Family history of dementia", "TimeYACD", "TimeYAD", "TimeYVD", "ACD", "AD", "VD", "prs", "insulin_usage", "stroke_history", "CVD_history", "genotype_array", "pc1", "pc2", "pc3", "pc4", "pc5", "pc6", "pc7", "pc8",
                 "pc9", "pc10", paste0("x", 1:15))
df_sub$PsRS_clean <- trimws(as.character(df_sub$PsRS))

## å¤„ç†ä¸€ä¸‹bmiç±»åˆ«
df_sub <- df_sub %>%
  mutate(BMI_category = cut(
    BMI,
    breaks = c(-Inf, 18.5, 25, 30, Inf),
    labels = c(1, 2, 3, 4),
    right = FALSE
  )) %>%
  mutate(BMI_category = as.numeric(as.character(BMI_category)))

## å¤„ç†havenåˆ—
df_sub <- df_sub %>%
  mutate(across(c(drinking, smoking, PRS), ~ as.character(haven::as_factor(.))))
df_sub <- df_sub[, -6]
write.csv(df_sub, "res_new.csv")
openxlsx::write.xlsx(df_sub, "res_new.xlsx")
```


## é¢„å¤„ç†æ•°æ®
```{R}
factor_col <- c("PsRS", "APOE_status", "Cancer history", 
                 "Hypertension history", "Cholesterol history", "Family history of dementia")

library(haven)
df_sub[factor_col] <- lapply(df_sub[factor_col], as_factor)
df_sub$ACD <- as.numeric(as.character(df_sub$ACD))
df_sub$AD <- as.numeric(as.character(df_sub$AD))
df_sub$VD <- as.numeric(as.character(df_sub$VD))
names(df_sub) <- gsub(" ", "_", names(df_sub))  # å°†ç©ºæ ¼æ”¹æˆä¸‹åˆ’çº¿
```

## å­˜ä¸€ä¸ªæ•°æ®
```{R}
saveRDS(df, "ukb_data.rds")
source("E:/charls_db/ORCI.R")
source("PAR.R")
```


```{R}
## coxå›å½’(ACD)
res1<-coxph(Surv(TimeYACD,ACD)~PsRS,data=df_sub)

res1_adj0 <- coxph(Surv(TimeYACD,ACD)~PsRS+Age+BMI+sex, data=df_sub)

res1_adj <- coxph(Surv(TimeYACD,ACD)~PsRS+sex+Age+BMI+APOE_status+`Cancer history`+`Hypertension history`+`Cholesterol history`+`Family history of dementia`, data=df_sub)

summary(res1)
summary(res1_adj0)
summary(res1_adj)

print(ORCI(res1))
print(ORCI(res1_adj0))
print(ORCI(res1_adj))

## è®¡ç®—ACDå„ç±»psrsçš„äººæ•°
sum(df_sub$PsRS_clean == '1' & df_sub$ACD == '1')
sum(df_sub$PsRS_clean == '2' & df_sub$ACD == '1')
sum(df_sub$PsRS_clean == '3' & df_sub$ACD == '1')

## è®¡ç®—par
calculate_pfp_boot(res1, exposure_var = "PsRS_clean", data = df_sub)
calculate_pfp_boot(res1_adj0, exposure_var = "PsRS_clean", data = df_sub)
calculate_pfp_boot(res1_adj, exposure_var = "PsRS_clean", data = df_sub)
```


```{R}
## coxå›å½’(AD)
res2<-coxph(Surv(TimeYAD,AD)~PsRS,data=df_sub)
res2_adj0 <- coxph(Surv(TimeYAD,AD)~PsRS+Age+BMI+sex, data=df_sub)
res2_adj <- coxph(Surv(TimeYAD,AD)~PsRS+sex+Age+BMI+APOE_status+`Cancer history`+`Hypertension history`+`Cholesterol history`+`Family history of dementia`, data=df_sub)


summary(res2)
summary(res2_adj0)
summary(res2_adj)

print(ORCI(res2))
print(ORCI(res2_adj0))
print(ORCI(res2_adj))

## è®¡ç®—å„ç±»å‹äººæ•°
sum(df_sub$PsRS_clean == '1' & df_sub$AD == '1')
sum(df_sub$PsRS_clean == '2' & df_sub$AD == '1')
sum(df_sub$PsRS_clean == '3' & df_sub$AD == '1')

## è®¡ç®—par
calculate_pfp_boot(res2, exposure_var = "PsRS_clean", data = df_sub)
calculate_pfp_boot(res2_adj0, exposure_var = "PsRS_clean", data = df_sub)
calculate_pfp_boot(res2_adj, exposure_var = "PsRS_clean", data = df_sub)
```

```{R}
## coxå›å½’(VD)
res3<-coxph(Surv(TimeYVD,VD)~PsRS,data=df_sub)
res3_adj0 <- coxph(Surv(TimeYVD,VD)~PsRS+Age+BMI+sex, data=df_sub)
res3_adj <- coxph(Surv(TimeYVD,VD)~PsRS+sex+Age+BMI+APOE_status+`Cancer history`+`Hypertension history`+`Cholesterol history`+`Family history of dementia`, data=df_sub)

summary(res3)
summary(res3_adj0)
summary(res3_adj)

print(ORCI(res3))
print(ORCI(res3_adj0))
print(ORCI(res3_adj))


## è®¡ç®—äººç¾¤ä¸ªæ•°
sum(df_sub$PsRS_clean == '1' & df_sub$VD == '1')
sum(df_sub$PsRS_clean == '2' & df_sub$VD == '1')
sum(df_sub$PsRS_clean == '3' & df_sub$VD == '1')

## è®¡ç®—par
calculate_pfp_boot(res3, exposure_var = "PsRS_clean", data = df_sub)
calculate_pfp_boot(res3_adj0, exposure_var = "PsRS_clean", data = df_sub)
calculate_pfp_boot(res3_adj, exposure_var = "PsRS_clean", data = df_sub)
```

## Each score Incrementè®¡ç®—
# å°†psrsè½¬åŒ–ä¸ºè¿ç»­å˜é‡ï¼Œç„¶åcoxå›å½’
```{r}
## ACD
res1_esi<-coxph(Surv(TimeYACD,ACD)~psrs,data=df_sub)
res1_adj0_esi <- coxph(Surv(TimeYACD,ACD)~psrs+sex+Age+BMI, data=df_sub)
res1_adj_esi <- coxph(Surv(TimeYACD,ACD)~psrs+sex+Age+BMI+APOE_status+`Cancer history`+`Hypertension history`+`Cholesterol history`+`Family history of dementia`, data=df_sub)

summary(res1_esi)
summary(res1_adj0_esi)
summary(res1_adj_esi)

print(ORCI(res1_esi))
print(ORCI(res1_adj0_esi))
print(ORCI(res1_adj_esi))

## AD
res2_esi<-coxph(Surv(TimeYAD,AD)~psrs,data=df_sub)
res2_adj0_esi <- coxph(Surv(TimeYAD,AD)~psrs+sex+Age+BMI, data=df_sub)
res2_adj_esi <- coxph(Surv(TimeYAD,AD)~psrs+sex+Age+BMI+APOE_status+`Cancer history`+`Hypertension history`+`Cholesterol history`+`Family history of dementia`, data=df_sub)

summary(res2_esi)
summary(res2_adj0_esi)
summary(res2_adj_esi)

print(ORCI(res2_esi))
print(ORCI(res2_adj0_esi))
print(ORCI(res2_adj_esi))

## VD
res3_esi<-coxph(Surv(TimeYVD,VD)~psrs,data=df_sub)
res3_adj0_esi <- coxph(Surv(TimeYVD,VD)~psrs+sex+Age+BMI, data=df_sub)
res3_adj_esi <- coxph(Surv(TimeYVD,VD)~psrs+sex+Age+BMI+APOE_status+`Cancer history`+`Hypertension history`+`Cholesterol history`+`Family history of dementia`, data=df_sub)

summary(res3_esi)
summary(res3_adj0_esi)
summary(res3_adj_esi)

print(ORCI(res3_esi))
print(ORCI(res3_adj0_esi))
print(ORCI(res3_adj_esi))
```



## å¯è§†åŒ–
```{r}
## ç»˜åˆ¶å¤šå› ç´ æ£®æ—å›¾
# ACD
library(ggplot2)
library(ggpubr)
survminer::ggforest(model = res1, data = as.data.frame(df_sub),cpositions = c(0.01, 0.15, 0.35), 
          refLabel = "Reference",
          fontsize = 1,
          noDigits = 2,
          main = "Cox Model of ACD")

survminer::ggforest(model = res1_adj, data = as.data.frame(df_sub),cpositions = c(0.01, 0.15, 0.35), 
          refLabel = "Reference",
          fontsize = 1,
          noDigits = 4,
          main = "Adjusted Cox Model of ACD")
```


```{r}
## ç»˜åˆ¶å¤šå› ç´ æ£®æ—å›¾
# AD
library(ggplot2)
library(ggpubr)
survminer::ggforest(model = res2, data = as.data.frame(df_sub),cpositions = c(0.01, 0.15, 0.35), 
          refLabel = "Reference",
          fontsize = 1,
          noDigits = 2,
          main = "Cox Model of AD")

survminer::ggforest(model = res2_adj, data = as.data.frame(df_sub),cpositions = c(0.01, 0.15, 0.35), 
          refLabel = "Reference",
          fontsize = 1,
          noDigits = 2,
          main = "Adjusted Cox Model of AD")
```


```{r}
## ç»˜åˆ¶å¤šå› ç´ æ£®æ—å›¾
# VD
library(ggplot2)
library(ggpubr)
survminer::ggforest(model = res3, data = as.data.frame(df_sub),cpositions = c(0.01, 0.15, 0.35), 
          refLabel = "Reference",
          fontsize = 1,
          noDigits = 2,
          main = "Cox Model of VD")

survminer::ggforest(model = res3_adj, data = as.data.frame(df_sub),cpositions = c(0.01, 0.15, 0.35), 
          refLabel = "Reference",
          fontsize = 1,
          noDigits = 2,
          main = "Adjusted Cox Model of VD")
```

## ä¸­é«˜PRSé£é™©äººç¾¤çš„PsRSçš„coxå›å½’
```{r}
source("PFP_bootstrap.R")

## ç­›é€‰ä¸­é«˜prsé£é™©çš„äººç¾¤
hm_prs <- subset(df_sub, subset = df_sub$PRS == 2 | df_sub$PRS == 3)
hm_prs$PsRS_clean <- trimws(as.character(hm_prs$PsRS))

## cox
# ACD
res4<-coxph(Surv(TimeYACD,ACD)~PsRS,data=hm_prs)
res4_adj0 <- coxph(Surv(TimeYACD,ACD)~PsRS+sex+Age+BMI, data=hm_prs)
res4_adj1 <- coxph(Surv(TimeYACD,ACD)~PsRS+sex+Age+BMI+APOE_status+`Cancer history`+`Hypertension history`+`Cholesterol history`+`Family history of dementia`, data=hm_prs)


res4_esi<-coxph(Surv(TimeYACD,ACD)~psrs,data=hm_prs)
res4_adj0_esi <- coxph(Surv(TimeYACD,ACD)~psrs+sex+Age+BMI, data=hm_prs)
res4_adj_esi <- coxph(Surv(TimeYACD,ACD)~psrs+sex+Age+BMI+APOE_status+`Cancer history`+`Hypertension history`+`Cholesterol history`+`Family history of dementia`, data=hm_prs)

summary(res4)
summary(res4_adj0)
summary(res4_adj)

summary(res4_esi)
summary(res4_adj0_esi)
summary(res4_adj_esi)

print(ORCI(res4))
print(ORCI(res4_adj0))
print(ORCI(res4_adj))
print(ORCI(res4_esi))
print(ORCI(res4_adj0_esi))
print(ORCI(res4_adj_esi))

## è®¡ç®—ACDå„ç±»psrsçš„äººæ•°
sum(hm_prs$PsRS_clean == '1' & hm_prs$ACD == '1')
sum(hm_prs$PsRS_clean == '2' & hm_prs$ACD == '1')
sum(hm_prs$PsRS_clean == '3' & hm_prs$ACD == '1')

## è®¡ç®—par(åé¢æ”¹ç”¨bootstrapæ±‚ç½®ä¿¡åŒºé—´ 5.13)
calculate_pfp_boot(res4, exposure_var = "PsRS_clean", data = hm_prs)
calculate_pfp_boot(res4_adj0, exposure_var = "PsRS_clean", data = hm_prs)
calculate_pfp_boot(res4_adj, exposure_var = "PsRS_clean", data = hm_prs)
```

```{r}
## cox
# AD
res5<-coxph(Surv(TimeYAD,AD)~PsRS,data=hm_prs)
res5_adj0 <- coxph(Surv(TimeYAD,AD)~PsRS+sex+Age+BMI, data=hm_prs)
res5_adj1 <- coxph(Surv(TimeYAD,AD)~PsRS+sex+Age+BMI+APOE_status+`Cancer history`+`Hypertension history`+`Cholesterol history`+`Family history of dementia`, data=hm_prs)


res5_esi<-coxph(Surv(TimeYAD,AD)~psrs,data=hm_prs)
res5_adj0_esi <- coxph(Surv(TimeYAD,AD)~psrs+sex+Age+BMI, data=hm_prs)
res5_adj_esi <- coxph(Surv(TimeYAD,AD)~psrs+sex+Age+BMI+APOE_status+`Cancer history`+`Hypertension history`+`Cholesterol history`+`Family history of dementia`, data=hm_prs)

summary(res5)
summary(res5_adj0)
summary(res5_adj)
summary(res5_esi)
summary(res5_adj0_esi)
summary(res5_adj_esi)

print(ORCI(res5))
print(ORCI(res5_adj0))
print(ORCI(res5_adj))
print(ORCI(res5_esi))
print(ORCI(res5_adj0_esi))
print(ORCI(res5_adj_esi))

## è®¡ç®—ADå„ç±»psrsçš„äººæ•°
sum(hm_prs$PsRS_clean == '1' & hm_prs$AD == '1')
sum(hm_prs$PsRS_clean == '2' & hm_prs$AD == '1')
sum(hm_prs$PsRS_clean == '3' & hm_prs$AD == '1')

## è®¡ç®—par
calculate_pfp_boot(res5, exposure_var = "PsRS_clean", data = hm_prs)
calculate_pfp_boot(res5_adj0, exposure_var = "PsRS_clean", data = hm_prs)
calculate_pfp_boot(res5_adj, exposure_var = "PsRS_clean", data = hm_prs)
```

```{r}
## cox
# VD
res6<-coxph(Surv(TimeYVD,VD)~PsRS,data=hm_prs)
res6_adj0 <- coxph(Surv(TimeYVD,VD)~PsRS+sex+Age+BMI, data=hm_prs)
res6_adj1 <- coxph(Surv(TimeYVD,VD)~PsRS+sex+Age+BMI+APOE_status+`Cancer history`+`Hypertension history`+`Cholesterol history`+`Family history of dementia`, data=hm_prs)


res6_esi<-coxph(Surv(TimeYVD,VD)~psrs,data=hm_prs)
res6_adj0_esi <- coxph(Surv(TimeYVD,VD)~psrs+sex+Age+BMI, data=hm_prs)
res6_adj_esi <- coxph(Surv(TimeYVD,VD)~psrs+sex+Age+BMI+APOE_status+`Cancer history`+`Hypertension history`+`Cholesterol history`+`Family history of dementia`, data=hm_prs)

summary(res6)
summary(res6_adj0)
summary(res6_adj)
summary(res6_esi)
summary(res6_adj0_esi)
summary(res6_adj_esi)

print(ORCI(res6))
print(ORCI(res6_adj0))
print(ORCI(res6_adj))
print(ORCI(res6_esi))
print(ORCI(res6_adj0_esi))
print(ORCI(res6_adj_esi))

## è®¡ç®—VDå„ç±»psrsçš„äººæ•°
sum(hm_prs$PsRS_clean == '1' & hm_prs$VD == '1')
sum(hm_prs$PsRS_clean == '2' & hm_prs$VD == '1')
sum(hm_prs$PsRS_clean == '3' & hm_prs$VD == '1')

## è®¡ç®—par
calculate_pfp_boot(res6, exposure_var = "PsRS_clean", data = hm_prs)
calculate_pfp_boot(res6_adj0, exposure_var = "PsRS_clean", data = hm_prs)
calculate_pfp_boot(res6_adj, exposure_var = "PsRS_clean", data = hm_prs)
```
```{R}
table(df_demen$PRS, df_demen$PsRS)
```

## PsRSå’ŒPRSçš„è”åˆåˆ†æ
```{r}
library(jstable)
library(coxphf)
df_sub$PRS <- as.factor(df_sub$PRS)
df_sub$PsRS <- as.factor(df_sub$PsRS)
#df_demen <- df_sub[df_sub$ACD == 1 | df_sub$AD == 1 | df_sub$VD == 1, ]

## ACD
res77 <- TableSubgroupMultiCox(
  formula = Surv(TimeYACD,ACD) ~ PsRS, 
  var_subgroups = c("PRS"),
  var_cov = c("sex", "APOE_status", "Age", "BMI", "cancer_history", "hypertension_history", 
              "cholesterol_usage", "Family_history_of_dementia", "insulin_usage", 
              "stroke_history", "CVD_history", "genotype_array", "pc1", "pc2", "pc3", "pc4", 
              "pc5", "pc6", "pc7", "pc8", "pc9", "pc10", "smoking", "drinking"),
  data =  df_sub, decimal.hr = 3
)


## AD
# å‘ç°ç±»åˆ«ä¸å¹³è¡¡ï¼Œéœ€è¦åˆå¹¶prsç»„åˆ«
df_sub$PsRS_rec <- dplyr::recode(df_sub$PsRS,
                                 1 = `1`,
                                 2 = `2`,
                                 2 = `3`)  # åˆå¹¶é«˜é£é™©è¿›ä¸­é£é™©ç»„
library(coxphf)
df_sub$PsRS <- as.numeric(df_sub$PsRS)

res8 <- TableSubgroupMultiCox(
  formula = Surv(TimeYAD, AD) ~ PsRS, 
  var_subgroups = c("PRS"), 
  var_cov = c("APOE_status", "Age", "BMI", "`cancer_history`", "`hypertension_history`", "`cholesterol_usage`", "`Family_history_of_dementia`"),
  data = df_sub,
  decimal.hr = 3
)

## VD
res9 <- TableSubgroupMultiCox(
  
  formula = Surv(TimeYVD,VD) ~ PsRS, 
  var_subgroups = c("PRS"),
  var_cov = c("APOE_status","Age", "BMI", "APOE_status", "`Cancer history`", "`Hypertension history`", "`Cholesterol history`", "`Family history of dementia`"),
  data =  df_sub, decimal.hr = 3
)

```


## æ£®æ—å›¾å¯è§†åŒ–äºšç»„åˆ†æç»“æœ
```{R}
# forest_theme
library(forestploter)
# åŠ è½½gridåŒ…
library(grid)

# æ£®æ—å›¾çš„æ ¼å¼è®¾ç½®
# åˆ›å»ºä¸€ä¸ªæ£®æ—å›¾ä¸»é¢˜ï¼Œå‘½åä¸ºtm
tm <- forest_theme(
  base_size = 10,        # åŸºæœ¬å­—ä½“å¤§å°è®¾ç½®ä¸º10
  ci_pch = 15,           # ç½®ä¿¡åŒºé—´ç‚¹å½¢çŠ¶è®¾ç½®ä¸º15ï¼ˆå®å¿ƒæ–¹å—ï¼‰
  #ci_col = "#762a83",   # ç½®ä¿¡åŒºé—´é¢œè‰²è®¾ç½®ä¸ºç´«è‰²ï¼ˆæ­¤è¡Œå·²æ³¨é‡Šï¼‰
  ci_col = "black",      # ç½®ä¿¡åŒºé—´é¢œè‰²è®¾ç½®ä¸ºé»‘è‰²
  ci_fill = "black",     # ç½®ä¿¡åŒºé—´å¡«å……é¢œè‰²è®¾ç½®ä¸ºé»‘è‰²
  ci_alpha = 0.8,        # ç½®ä¿¡åŒºé—´é€æ˜åº¦è®¾ç½®ä¸º0.8
  ci_lty = 1,            # ç½®ä¿¡åŒºé—´çº¿å‹è®¾ç½®ä¸ºå®çº¿
  ci_lwd = 2,          # ç½®ä¿¡åŒºé—´çº¿å®½è®¾ç½®ä¸º2
  ci_Theight = 0.2,      # ç½®ä¿¡åŒºé—´æ¨ªçº¿é«˜åº¦è®¾ç½®ä¸º0.2
  refline_lwd = 1.5,       # å‚è€ƒçº¿çº¿å®½è®¾ç½®ä¸º1.5
  refline_lty = "dashed",# å‚è€ƒçº¿çº¿å‹è®¾ç½®ä¸ºè™šçº¿
  refline_col = "grey20",# å‚è€ƒçº¿é¢œè‰²è®¾ç½®ä¸ºç°è‰²
  vertline_lwd = -0.1,   # å‚ç›´çº¿çº¿å®½è®¾ç½®ä¸º-0.1ï¼ˆéšè—ï¼‰
  vertline_lty = "dashed",# å‚ç›´çº¿çº¿å‹è®¾ç½®ä¸ºè™šçº¿
  vertline_col = "red",  # å‚ç›´çº¿é¢œè‰²è®¾ç½®ä¸ºçº¢è‰²
  summary_fill = "blue", # æ±‡æ€»éƒ¨åˆ†å¡«å……é¢œè‰²è®¾ç½®ä¸ºè“è‰²
  summary_col = "#4575b4",# æ±‡æ€»éƒ¨åˆ†é¢œè‰²è®¾ç½®ä¸ºæ·±è“è‰²
  footnote_cex = 0.6,    # æ³¨è„šå­—ä½“å¤§å°è®¾ç½®ä¸º0.6
  footnote_fontface = "italic",# æ³¨è„šå­—ä½“æ ·å¼è®¾ç½®ä¸ºæ–œä½“
  footnote_col = "grey20" # æ³¨è„šé¢œè‰²è®¾ç½®ä¸ºç°è‰²
)

## é¢„å¤„ç†äºšç»„åˆ†æç»“æœ
res5 %>% write.csv(file="subgroup_analysis0.csv")
res7 <- read.csv(file="subgroup_analysis.csv")

# Count/Percent/P value/P for interactionï¼Œ4åˆ—çš„ç©ºå€¼è®¾ä¸ºç©ºæ ¼
res7[, c(2, 3, 9, 10)][is.na(res7[, c(2, 3, 9, 10)])] <- " "  

# æ·»åŠ ç©ºç™½åˆ—ï¼Œç”¨äºå­˜æ”¾æ£®æ—å›¾çš„å›¾å½¢éƒ¨åˆ†
res7$` ` <- paste(rep(" ", nrow(res7)), collapse = " ")

# Count/Point Estimate/Lower/Upper, 4åˆ—æ•°æ®è½¬æ¢ä¸ºæ•°å€¼å‹
res7[, c(2,5,6,7)] <- apply(res7[, c(2,5,6,7)], 2, as.numeric)

# è®¡ç®—HR (95% CI)ï¼Œä»¥ä¾¿æ˜¾ç¤ºåœ¨å›¾å½¢ä¸­
res7$"HR (95% CI)" <- ifelse(is.na(res7$"Point.Estimate"), "",
                                 sprintf("%.3f (%.3f to %.3f)",
                                         res7$"Point.Estimate", res7$Lower, res7$Upper))

colnames(res7)[11] <- "HR (95% CI)"

# ä¸­é—´åœ†ç‚¹çš„å¤§å°ï¼Œä¸Countå…³è”ï¼Œæ•°å€¼å‹
res7$se <- as.numeric(ifelse(is.na(res7$Count), " ", round(res7$Count / 1500, 4)))

# Countåˆ—çš„ç©ºå€¼è®¾ä¸ºç©ºæ ¼
res7[, c(2)][is.na(res7[, c(2)])] <- " "  

res7 <- res7[,-15]

# Percentåˆ—é‡å‘½åï¼ŒåŠ ä¸Š%
res7 <- dplyr::rename(res7, 'Percent(%)' = Percent...) 
res7 <- dplyr::rename(res7, 'P value' = P.value) 

## ä¿®æ”¹countå’Œpercent
res7_count <- c(6, 40, 3, 15, 125, 13, 5, 71, 7)
res7_count_per <- round((res7_count / sum(res7_count)), 3) * 100
res7$Count <- " "
res7$Count[3:5] <- c("6", "40", "3")
res7$Count[7:9] <- c("15", "125", "13")
res7$Count[11:13] <- c("5", "71", "7")
res7$`Percent(%)` <- res7$Count
res7$`Percent(%)`[3:5] <- c("2.1%", "14.0%", "1.1%")
res7$`Percent(%)`[7:9] <- c("5.3%", "43.9%", "4.6%")
res7$`Percent(%)`[11:13] <- c("1.8%", "24.9%", "2.5%")

# æ£®æ—å›¾ç»˜åˆ¶
plot_sub <- forest(
  #é€‰æ‹©éœ€è¦ç”¨äºç»˜å›¾çš„åˆ—ï¼šVariable/Count/ç©ºç™½åˆ—/HR(95%CI)/P value
  data = res7[, c(1, 2, 3, 14, 11, 9)],  
  lower = res7$Lower,  #ç½®ä¿¡åŒºé—´ä¸‹é™
  upper = res7$Upper,  #ç½®ä¿¡åŒºé—´ä¸Šé™
  est = res7$`Point.Estimate`,  #ç‚¹ä¼°è®¡å€¼
  sizes = res7$se*0.15,
  ci_column = 4,  #ç‚¹ä¼°è®¡å¯¹åº”çš„åˆ—
  ref_line = 1,   #è®¾ç½®å‚è€ƒçº¿ä½ç½®
  xlim = c(0, 5),  # xè½´çš„èŒƒå›´
  ticks_at = c(0,1,2,3, 4, 5),
  theme = tm
)
plot_sub
#write.csv(res5, file = "subgroup_analysis.csv")
#res5 <- read.csv("subgroup_analysis.csv")
```

## ç¾åŒ–æ£®æ—å›¾
```{r}
plot_sub <- plot_sub %>% 
  # æŒ‡å®šè¡ŒåŠ ç²—
  edit_plot(row = c(1),
            col=c(1),
            gp = gpar(fontface = "bold")) %>%
  # æœ€ä¸Šä¾§ç”»æ¨ªçº¿
  add_border(part = c("header")) %>%
  # æœ€ä¸‹ä¾§ç”»æ¨ªçº¿
  add_border(row= 13) 
  
plot_sub
ggsave("interaction_forestplot.pdf", plot = plot_sub, width = 8, height = 5, units = "in", dpi = 300)
```


## å¯¹ä¸­é«˜prsé£é™©äººç¾¤ï¼Œx1-x12çš„é¢„æµ‹æ¨¡å‹æ„å»º
```{R}
## hm_prs_l
hm_prs_l <- subset(df, subset = df$PRS == 2 | df$PRS == 3)

## æ„å»ºACDé¢„æµ‹æ¨¡å‹
hp_model1 <- glm(VD ~ x1 + x2 + x3 + x4 +
                   x5 + x6 + x7 + x8 + x9 + x10 +
                   x11 + x12 + x13 + x14 + x15, data = hm_prs_l, 
                 family = binomial)

summary(hp_model1)

## æ„å»ºADé¢„æµ‹æ¨¡å‹
hp_model2 <- glm(AD ~ x1 + x2 + x3 + x4 +
                   x5 + x6 + x7 + x8 + x9 + x10 +
                   x11 + x12 + x13 + x14 + x15 + smoking + drinking + 
                   insulin + choloresteral + hypertension + 
                   cancer + stroke + BMI, data = high_prs, family = binomial)

summary(hp_model2)

## æ„å»ºVDé¢„æµ‹æ¨¡å‹
hp_model3 <- glm(VD ~ x1 + x2 + x3 + x4 +
                   x5 + x6 + x7 + x8 + x9 + x10 +
                   x11 + x12 + x13 + x14 + x15 + smoking + drinking + 
                   insulin + choloresteral + hypertension + 
                   cancer + stroke + BMI, data = high_prs, family = binomial)

summary(hp_model3)
```

## employment statusçš„è¯¦ç»†ç ”ç©¶
```{R}
## æˆªå–åˆ†æçš„æ•°æ®
es <- df[, c("employment_status0","drinking", "smoking", "sex", "PSRS_3", "psrs", "PRS","age", "BMI", "Apoe", "cancer", 
                 "hypertension", "choloresteral", "family_history", "TimeYACD", "TimeYAD", "TimeYVD", "ACD", "AD", "VD", "SCORE1_AVG")]
colnames(es) <- c("employment_status","drinking", "smoking", "sex", "PsRS", "psrs", "PRS","Age", "BMI", "APOE_status", "Cancer history", 
                 "Hypertension history", "Cholesterol history", "Family history of dementia", "TimeYACD", "TimeYAD", "TimeYVD", "ACD", "AD", "VD", "prs")
es$PsRS_clean <- trimws(as.character(es$PsRS))
```


## å¯¹esè¿›è¡Œé‡ç¼–ç 
```{R}
library(dplyr)

# å‘ç°studentå’Œvolunteerè¿™ä¸€ç±»å¾ˆå°‘äººï¼Œè€ƒè™‘å‰”é™¤
es <- es %>%
  mutate(
    employment_group = case_when(
      employment_status == 1 ~ "working",
      employment_status == 2 ~ "retired",
      employment_status == 3 ~ "home",
      employment_status == 4 ~ "disabled",
      employment_status == 5 ~ "unemployed",
      employment_status == 6 ~ "volunteer",
      employment_status == 7 ~ "student",
      employment_status == -7 ~ NA_character_,
      TRUE ~ NA_character_
    )
  ) %>%
  # ğŸ”¥ å»é™¤ student å’Œ volunteer
  filter(!employment_group %in% c("student", "volunteer")) %>%
  subset(PRS == 2 | PRS == 3) %>%
  # âœ… é‡æ–°è®¾ç½®å› å­ levels
  mutate(employment_group = factor(employment_group, levels = c(
    "working", "disabled", "retired", "unemployed", "home"
  )))


## é€»è¾‘å›å½’
es_model <- glm(ACD ~ employment_group, data = es, family = binomial)
summary(es_model)
print(ORCI(es_model))


## è°ƒæ•´åå˜é‡çš„æ¨¡å‹
es_model_new1 = glm(ACD ~ employment_group+sex+Age+BMI, data = es, family = binomial)
summary(es_model_new1)
print(ORCI(es_model_new1))

es_model_new2 = glm(ACD ~ employment_group+sex+Age+BMI+APOE_status+`Cancer history`+`Hypertension history`+`Cholesterol history`+`Family history of dementia`, data = es, family = binomial)
summary(es_model_new2)
print(ORCI(es_model_new2))
```


## educational levelçš„è¯¦ç»†ç ”ç©¶
```{R}
## æˆªå–åˆ†æçš„æ•°æ®
el <- df[, c("education_qualifications0","drinking", "smoking", "sex", "PSRS_3", "psrs", "PRS","age", "BMI", "Apoe", "cancer", 
                 "hypertension", "choloresteral", "family_history", "TimeYACD", "TimeYAD", "TimeYVD", "ACD", "AD", "VD", "SCORE1_AVG")]
colnames(el) <- c("education level","drinking", "smoking", "sex", "PsRS", "psrs", "PRS","Age", "BMI", "APOE_status", "Cancer history", 
                 "Hypertension history", "Cholesterol history", "Family history of dementia", "TimeYACD", "TimeYAD", "TimeYVD", "ACD", "AD", "VD", "prs")
el$PsRS_clean <- trimws(as.character(el$PsRS))
el <- el %>%
  mutate(PRS = as.numeric(PRS)) %>%
  filter(PRS %in% c(2, 3))
```


## å¯¹elè¿›è¡Œé‡ç¼–ç 
```{R}
el <- el %>%
  mutate(
    edu_level = ifelse(`education level` == 1, "Higher", "Lower"),
    edu_level = factor(edu_level, levels = c("Higher", "Lower"))  # ä»¥ Higher ä¸ºå‚è€ƒç»„
  )


## é€»è¾‘å›å½’
el_model <- glm(ACD ~ edu_level, data = el, family = binomial)
summary(el_model)
print(ORCI(el_model))


## è°ƒæ•´åå˜é‡çš„æ¨¡å‹
el_model_new1 = glm(ACD ~ edu_level+sex+Age+BMI, data = el, family = binomial)
summary(el_model_new1)
print(ORCI(el_model_new1))

el_model_new2 = glm(ACD ~ edu_level+sex+Age+BMI+APOE_status+`Cancer history`+`Hypertension history`+`Cholesterol history`+`Family history of dementia`, data = el, family = binomial)
summary(el_model_new2)
print(ORCI(el_model_new2))
```

